# export GCP_AUTH_KIND=serviceaccount
# export GCP_SERVICE_ACCOUNT_FILE=/home/filip/webserver1-283520-386230d8738c.json
# export GCP_SCOPES=https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/cloud-platform
# ansible-playbook db.yaml
---
- hosts: localhost
  vars:
    ### Cloud_SQL instance specifications
    # backend_type: FIRST_GEN / SECOND_GEN / EXTERNAL
    # database_version: MYSQL_5_5 / MYSQL_5_6 / MYSQL_587 / POSTGRESQL_9_6
    # tier: db-g1-smal / db-pg-g1-small / custom-2-2048
    sql_instance:
      name: webserverdb5
      backend_type: SECOND_GEN
      database_version: POSTGRES_12
      region: us-west1
      tier: db-g1-small
    project_id: webserver1-283520
  tasks:
    - name: Create GCP CloudSQL instance
      gcp_sql_instance:
        name: '{{ sql_instance.name }}'
        backend_type: '{{ sql_instance.backend_type }}'
        database_version: '{{ sql_instance.database_version }}'
        settings:
          tier: '{{ sql_instance.tier }}'
          ip_configuration:
            authorized_networks:
              - name: google dns server
                value: 8.8.8.8/32
        region: '{{ sql_instance.region }}'
        project: '{{ project_id }}'
        state: present
      register: instance
    - debug:
        msg: '{{ instance }}'
    - name: Create database
      gcp_sql_database:
        name: einvoice
        charset: utf8
        instance: "{{ instance.name }}"
        project: '{{ project_id }}'
        state: present
    - name: create a user
      gcp_sql_user:
        name: einvoice
        host: '{{ instance.ipAddresses[0].ipAddress }}'
        password: 12345
        instance: "{{ instance }}"
        project: '{{ project_id }}'
        state: present

